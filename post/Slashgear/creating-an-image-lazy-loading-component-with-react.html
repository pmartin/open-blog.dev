<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creating an image lazy loading component with React | Open blog</title>
    <meta name="description" content="Share blog posts on an free open platform">
    
    <meta name="title" content="Creating an image lazy loading component with React"><meta name="og-title" content="Creating an image lazy loading component with React"><meta name="og-description" content="In the web world, we often have complex page structure. All the parts are not visible in the user viewport at first. Why should we load all the page content to be able to see it ?"><meta name="og-image" content="https://open-blog.dev/Slashgear/lazy-load.gif"><meta name="author" content="Antoine Caron">
    <link rel="preload" href="/assets/css/0.styles.6fff224e.css" as="style"><link rel="preload" href="/assets/js/app.4c3a8a0d.js" as="script"><link rel="preload" href="/assets/js/2.ceada549.js" as="script"><link rel="preload" href="/assets/js/8.1b20a4bf.js" as="script"><link rel="preload" href="/assets/js/3.8a84c816.js" as="script"><link rel="preload" href="/assets/js/4.016bd1cf.js" as="script"><link rel="prefetch" href="/assets/js/10.4122612c.js"><link rel="prefetch" href="/assets/js/11.0386a0c0.js"><link rel="prefetch" href="/assets/js/12.8e2b1efc.js"><link rel="prefetch" href="/assets/js/5.f77cbde1.js"><link rel="prefetch" href="/assets/js/6.f3388a59.js"><link rel="prefetch" href="/assets/js/7.5d59a2a4.js"><link rel="prefetch" href="/assets/js/9.b9915c81.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6fff224e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Open blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/contributing.html" class="nav-link">Contribute</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/post/Slashgear/creating-an-image-lazy-loading-component-with-react.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/fr/" class="nav-link">Français</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/contributing.html" class="nav-link">Contribute</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/post/Slashgear/creating-an-image-lazy-loading-component-with-react.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/fr/" class="nav-link">Français</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Creating an image lazy loading component with React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/post/Slashgear/creating-an-image-lazy-loading-component-with-react.html#example-with-a-pictures-grid" class="sidebar-link">Example with a pictures grid</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/Slashgear/creating-an-image-lazy-loading-component-with-react.html#let-s-lazy-load-images" class="sidebar-link">Let's lazy load images</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/post/Slashgear/creating-an-image-lazy-loading-component-with-react.html#intersection-observer-for-the-win" class="sidebar-link">Intersection Observer for the win</a></li><li class="sidebar-sub-header"><a href="/post/Slashgear/creating-an-image-lazy-loading-component-with-react.html#pimp-it-up-with-style" class="sidebar-link">Pimp it up with style</a></li></ul></li><li><a href="/post/Slashgear/creating-an-image-lazy-loading-component-with-react.html#going-further" class="sidebar-link">Going further</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="creating-an-image-lazy-loading-component-with-react"><a href="#creating-an-image-lazy-loading-component-with-react" aria-hidden="true" class="header-anchor">#</a> Creating an image lazy loading component with React</h1> <p>In the web world, we often have complex page structure.
All the parts are not visible in the user viewport at first.
Why should we load all the page content to be able to see it ?</p> <p>By default, the browser load images in the lower part of you website, even if the user can't see them at first.
It could slow down the performance of your website.</p> <div class="tip custom-block"><p class="custom-block-title">Note</p> <p>Every website audit tool will ask you to set up lazy loading on images. But how to do it with React ?</p></div> <p><img src="https://open-blog.dev/Slashgear/lazy-load.gif" alt="example of image lazy loading"></p> <h2 id="example-with-a-pictures-grid"><a href="#example-with-a-pictures-grid" aria-hidden="true" class="header-anchor">#</a> Example with a pictures grid</h2> <p>In order to show you how to do it with React, I bootstrapped a small app showing a grid of 1000 images.
I used styled-component as CSS in JS framework (CSS is JS is not required to lazy load images).</p> <iframe src="https://codesandbox.io/embed/m42qm215py?fontsize=14" title="Eager loading images" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin" style="width:100%;height:500px;border:0;border-radius:4px;overflow:hidden;"></iframe> <p>If you open a tab with your devtools opened, you will realize that:</p> <ul><li>many HTTP queries has been made by your browser to fetch all the images.</li> <li>all broken images have no fallback in order to have a smoother feeling.</li></ul> <p>NB: loading 1000 images in a page is a very bad practice. It is just for the example here.</p> <h2 id="let-s-lazy-load-images"><a href="#let-s-lazy-load-images" aria-hidden="true" class="header-anchor">#</a> Let's lazy load images</h2> <p>Let's create a dedicated component with an image placeholder.</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> styled <span class="token keyword">from</span> <span class="token string">&quot;styled-components&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Image <span class="token operator">=</span> styled<span class="token punctuation">.</span>img<span class="token template-string"><span class="token string">`
  display: block;
  height: 100px;
  width: 100px;
`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> placeHolder <span class="token operator">=</span>
  <span class="token string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkqAcAAIUAgUW0RjgAAAAASUVORK5CYII=&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">LazyImage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span></span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>placeHolder<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>If you use this component instead of a simple <code>img</code> tag, you won't load image at all.
It will display the placeholder here encoded in <code>base64</code>.
This simple trick will let your browser show an image without generating an HTTP request because it is already <em>hardcoded</em> in the source.</p> <p>Base64 image source is just 1x1 pixel wide png. With that component, your browser won't load the real image. We need to tell him <em>when</em> to do it.</p> <h3 id="intersection-observer-for-the-win"><a href="#intersection-observer-for-the-win" aria-hidden="true" class="header-anchor">#</a> Intersection Observer for the win</h3> <p>Now let's try to trigger real image loading when the user really need it.
For that, we would need to have an API that let us know if an element is visible in user viewport.
That is exactly what <a href="https://developer.mozilla.org/fr/docs/Web/API/Intersection_Observer_API" target="_blank" rel="noopener noreferrer">IntersectionObserver<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> provides us.</p> <p><img src="/assets/img/intersection-observer-caniuse.e853e350.png" alt="IntersectionObserver support in March 2019"></p> <p>Intersection observer API provides us observe method to check on the visibility of an HTML element using its own ref.
In order to follow last React API, I used <em>Hooks</em> to keep a simple functional component with state and lifecycle.</p> <p>If you don't know what are Hooks or how to use them, take a look at my friend and colleague Matthieu Lux (<a href="https://twitter.com/swiip?lang=fr" target="_blank" rel="noopener noreferrer">@Swiip<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) with his <a href="https://medium.zenika.com/react-hooks-my-introduction-81b15e6eff20" target="_blank" rel="noopener noreferrer">React Hooks : my introduction article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>I had to use <code>useState</code> to handle the <code>img ref</code> in order to correctly trigger my side effect only when the <code>ref</code> is correctly loaded.
Take a look at <a href="https://medium.com/@teh_builder/ref-objects-inside-useeffect-hooks-eb7c15198780" target="_blank" rel="noopener noreferrer">this article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which explains why we can't use <code>useRef</code> with <code>useEffect</code>.</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> styled <span class="token keyword">from</span> <span class="token string">&quot;styled-components&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Image <span class="token operator">=</span> styled<span class="token punctuation">.</span>img<span class="token template-string"><span class="token string">`
  display: block;
  height: 100px;
  width: 100px;
`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> placeHolder <span class="token operator">=</span>
  <span class="token string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkqAcAAIUAgUW0RjgAAAAASUVORK5CYII=&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">LazyImage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> src<span class="token punctuation">,</span> alt <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>imageSrc<span class="token punctuation">,</span> setImageSrc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>placeHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>imageRef<span class="token punctuation">,</span> setImageRef<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> observer<span class="token punctuation">;</span>
    <span class="token keyword">let</span> didCancel <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>imageRef <span class="token operator">&amp;&amp;</span> imageSrc <span class="token operator">===</span> placeHolder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IntersectionObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>
          <span class="token parameter">entries</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entry</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">// when image is visible in the viewport + rootMargin</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>
                <span class="token operator">!</span>didCancel <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>intersectionRatio <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span>
              <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setImageSrc</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            threshold<span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span>
            rootMargin<span class="token punctuation">:</span> <span class="token string">&quot;75%&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>imageRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Old browsers fallback</span>
        <span class="token function">setImageSrc</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      didCancel <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// on component unmount, we remove the listner</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">&amp;&amp;</span> observer<span class="token punctuation">.</span>unobserve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>imageRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setImageRef<span class="token punctuation">}</span></span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>imageSrc<span class="token punctuation">}</span></span> <span class="token attr-name">alt</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>alt<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>In this brand new implementation, I just made the component trigger image loading only when 1% of the image is visible in the viewport.</p> <p>You can also note that if Intersection Observer is not available, it will trigger image loading.
As a consequence, some browsers won't be able to lazy load images.</p> <p>You can also add margin on the viewport trigger, to make your browser load image if they are visible in the viewport + margin.</p> <h3 id="pimp-it-up-with-style"><a href="#pimp-it-up-with-style" aria-hidden="true" class="header-anchor">#</a> Pimp it up with style</h3> <p>With that shiny LazyImage component, we are now able to let browser load image at will.
But we still not have a nice animation to display the loading to the user.</p> <p>In order to make it smooth, I just had to handle <code>onLoad</code> and <code>onError</code> native event with custom CSS class to display image correctly.</p> <p>This is the <a href="https://codesandbox.io/s/34vpxnno9p?fontsize=14" target="_blank" rel="noopener noreferrer">LazyImage component<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> :</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> styled <span class="token keyword">from</span> <span class="token string">&quot;styled-components&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> placeHolder <span class="token operator">=</span>
  <span class="token string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkqAcAAIUAgUW0RjgAAAAASUVORK5CYII=&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Image <span class="token operator">=</span> styled<span class="token punctuation">.</span>img<span class="token template-string"><span class="token string">`
  display: block;
  height: 100px;
  width: 100px;
  // Add a smooth animation on loading
  @keyframes loaded {
    0% {
      opacity: 0.1;
    }
    100% {
      opacity: 1;
    }
  }
  // I use utilitary classes instead of props to avoid style regenerating
  &amp;.loaded:not(.has-error) {
    animation: loaded 300ms ease-in-out;
  }
  &amp;.has-error {
    // fallback to placeholder image on error
    content: url(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>placeHolder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);
  }
`</span></span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">LazyImage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> src<span class="token punctuation">,</span> alt <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>imageSrc<span class="token punctuation">,</span> setImageSrc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>placeHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>imageRef<span class="token punctuation">,</span> setImageRef<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onLoad</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;loaded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onError</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;has-error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> observer<span class="token punctuation">;</span>
      <span class="token keyword">let</span> didCancel <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>imageRef <span class="token operator">&amp;&amp;</span> imageSrc <span class="token operator">!==</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IntersectionObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>
            <span class="token parameter">entries</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entry</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                  <span class="token operator">!</span>didCancel <span class="token operator">&amp;&amp;</span>
                  <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>intersectionRatio <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span>
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token function">setImageSrc</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>imageRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              threshold<span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span>
              rootMargin<span class="token punctuation">:</span> <span class="token string">&quot;75%&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>imageRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// Old browsers fallback</span>
          <span class="token function">setImageSrc</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        didCancel <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// on component cleanup, we remove the listner</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>observer <span class="token operator">&amp;&amp;</span> observer<span class="token punctuation">.</span>unobserve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>imageRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>src<span class="token punctuation">,</span> imageSrc<span class="token punctuation">,</span> imageRef<span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span></span>
      <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setImageRef<span class="token punctuation">}</span></span>
      <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>imageSrc<span class="token punctuation">}</span></span>
      <span class="token attr-name">alt</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>alt<span class="token punctuation">}</span></span>
      <span class="token attr-name">onLoad</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onLoad<span class="token punctuation">}</span></span>
      <span class="token attr-name">onError</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onError<span class="token punctuation">}</span></span>
    <span class="token punctuation">/&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><iframe src="https://codesandbox.io/embed/34vpxnno9p?fontsize=14" title="Lazy loading" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin" style="width:100%;height:500px;border:0;border-radius:4px;overflow:hidden;"></iframe> <h2 id="going-further"><a href="#going-further" aria-hidden="true" class="header-anchor">#</a> Going further</h2> <p>Lazy loading is key to make an awesome user experience.
This article is only focused on images loading. However, with React you can lazy load more than just images.
Thanks to <code>React.lazy</code> and <code>React.Suspense</code> feature, you could also lazy load components and related code.</p> <p>In the upcoming version of React (currently in 16.8.5), we will be able to use <em>createFetcher</em> (a still work in progress feature) to let us control lazy loading and fallback of <em>asynchronous rendered components</em>.
If you are curious, take a look at this conference about the upcoming features.</p> <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/nLF0n9SACd4?controls=0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe> <hr> <section class="author" data-v-77820e12><img src="https://pbs.twimg.com/profile_images/970399793485897729/NW8ACov8_400x400.jpg" alt="profile" class="author__profile" data-v-77820e12> <div class="author__description" data-v-77820e12><h3 class="author__name" data-v-77820e12>
      Antoine Caron
      (Slashgear)</h3> <div class="author__bio" data-v-77820e12>Frontend dev working at M6 (French TV channel) for Zenika. Teacher in engineering school.</div> <div class="author_socials" data-v-77820e12><a href="https://twitter.com/Slashgear_" data-v-77820e12><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="twitter" role="img" viewBox="0 0 512 512" class="svg-inline--fa fa-twitter fa-w-16" data-v-77820e12><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z" data-v-77820e12></path></svg></a> <a href="https://github.com/Slashgear" data-v-77820e12><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svg-inline--fa fa-github fa-w-16" data-v-77820e12><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" data-v-77820e12></path></svg></a></div></div></section></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/2/2019, 7:24:31 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4c3a8a0d.js" defer></script><script src="/assets/js/2.ceada549.js" defer></script><script src="/assets/js/8.1b20a4bf.js" defer></script><script src="/assets/js/3.8a84c816.js" defer></script><script src="/assets/js/4.016bd1cf.js" defer></script>
  </body>
</html>
